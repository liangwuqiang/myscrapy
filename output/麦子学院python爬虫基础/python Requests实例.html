<!DOCTYPE html>
        <html><head><meta charset="UTF-8">
        </head><body>
        <p><center><h1>python Requests实例</h1></center></p>
            <div class="cont">
<h1>python Requests实例</h1>
<p><p><br/></p><hr/><h3><span style="color: rgb(94, 207, 186);">用Requests重构豆瓣电影爬虫</span></h3><p><br/></p><p>1）用Requests重构代码</p><p><br/></p><p>2）增加功能：下载每个电影的海报的图片</p><p><br/></p><p><strong>热播电影数据格式：</strong></p><p><br/></p><p>使用Chrome开发者工具查看豆瓣热播电影格式</p><p><br/></p><p><strong>示例：</strong></p><p><strong><br/></strong></p><p>使用Requests重构代码</p><p><br/></p><p>代码如下：</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class MovieParser(HTMLParser):</p><p>    def __init__(self):</p><p>        HTMLParser.__init__(self)</p><p>        self.movies = []</p><p><br/></p><p>    def handle_starttag(self, tag, attrs):</p><p>        def _attr(attrlist, attrname):</p><p>            for attr in attrlist:</p><p>                if attr[0] == attrname:</p><p>                    return attr[1]</p><p>            return None</p><p><br/></p><p>        if tag == 'li' and _attr(attrs, 'data-title') and _attr(attrs, 'data-category') == 'nowplaying':</p><p>            movie = {}</p><p>            movie['title'] = _attr(attrs, 'data-title')</p><p>            movie['score'] = _attr(attrs, 'data-score')</p><p>            movie['director'] = _attr(attrs, 'data-director')</p><p>            movie['actors'] = _attr(attrs, 'data-actors')</p><p>            self.movies.append(movie)</p><p>            print('%(title)s|%(score)s|%(director)s|%(actors)s' % movie)</p><p><br/></p><p>if __name__ == '__main__':</p><p>    url = 'http://movie.douban.com/nowplaying/xiamen/'</p><p>    movies = nowplaying_movies(url)</p><p><br/></p><p>    import json</p><p>print('%s' % json.dumps(movies, sort_keys=True, indent=4, separators=(',', ': ')))</p><p><br/></p><p>运行结果，是成功的</p><p><br/></p><p><img alt="request2.png" height="163" src="images/36bf2c2461b0ec37a103aedda0af1ec9.png" style="width: 814px; height: 163px;" title="fMdBA9XxVE23iRwjaA.png" width="814"/></p><p><br/></p><p>增加图片的下载功能，我们需要先去分析数据的格式，我们先去看这个图片的格式。</p><p><br/></p><p>点击图片，我们看一下这个图片在哪里。</p><p><br/></p><p><img alt="request3.png" src="images/aad9a1678873c5c95bb81f8538222e1f.png" title="pFRDDPdXnX04F7qf1z.png"/></p><p><br/></p><p>实际上是由这个HTML来表达的</p><p><br/></p><p><img alt="request4.png" src="images/d5506d9a16d419c796748a4fead0c73f.png" title="URWWRksZtg4esJEvB9.png"/></p><p><br/></p><p>可以看到，这是我们的电影数据。这个爬虫是解析这个li的标签去获取这个数据的。</p><p><br/></p><p><img alt="request5.png" src="images/7642f28cb002f9d7d452e097d6347bb8.png" title="76EL5d04tLSugHo9bQ.png"/></p><p><br/></p><p>我们在解析，下载图片的时候，我们要确保这个图片是在这个电影标签下面的，否则这个里面可能会有很多其他的图片，所以，这里面需要我们去过滤这个图片，也就是说，我们只下载这个li下面的img的图片，那这个图片的url就是我们要去获取的url。</p><p><br/></p><p><img alt="request6.png" src="images/88fd384822f2e1c69507939ef2fb2878.png" title="Fa7ZDgoJpHiILDr5AO.png"/></p><p><br/></p><p>我们看一下代码怎么做。</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p><br/></p><p>class MovieParser(HTMLParser):</p><p>    def __init__(self):</p><p>        HTMLParser.__init__(self)</p><p>        self.movies = []</p><p>        self.in_movies = False //标示我们正在解析的电影是在这个数据里面的</p><p><br/></p><p>    def handle_starttag(self, tag, attrs):</p><p>        def _attr(attrlist, attrname):</p><p>            for attr in attrlist:</p><p>                if attr[0] == attrname:</p><p>                    return attr[1]</p><p>            return None</p><p><br/></p><p>        if tag == 'li' and _attr(attrs, 'data-title') and _attr(attrs, 'data-category') == 'nowplaying':</p><p>            movie = {}</p><p>            movie['title'] = _attr(attrs, 'data-title')</p><p>            movie['score'] = _attr(attrs, 'data-score')</p><p>            movie['director'] = _attr(attrs, 'data-director')</p><p>            movie['actors'] = _attr(attrs, 'data-actors')</p><p>            self.movies.append(movie)</p><p>            print('%(title)s|%(score)s|%(director)s|%(actors)s' % movie)</p><p>            self.in_movies = True   //表示我们已经解析到了这个电影</p><p><br/></p><p>        if tag == 'img' and self.in_movies:   //解析img标签并且在电影数据里面才会关注</p><p>            self.in_movies = False  //将电影设置为false</p><p>src = _attr(attrs,’src’)</p><p>            movie = self.movies[len(self.movies) - 1]  //获取刚刚append进去的电影</p><p>            movie['cover-url'] = _attr(attrs, 'src')</p><p>           </p><p>def nowplaying_movies(url):</p><p>    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36'}</p><p>    s = requests.get(url, headers=headers)</p><p>    parser = MovieParser()</p><p>    parser.feed(s.content)</p><p>    return parser.movies</p><p><br/></p><p><br/></p><p>if __name__ == '__main__':</p><p>    url = 'http://movie.douban.com/nowplaying/xiamen/'</p><p>    movies = nowplaying_movies(url)</p><p><br/></p><p>    import json</p><p>print('%s' % json.dumps(movies, sort_keys=True, indent=4, separators=(',', ': ')))</p><p><br/></p><p>运行结果，这个我们post的url，封面数据就有了。</p><p><br/></p><p><img alt="request7.png" height="161" src="images/cf2a1cfb16eee8f70954f9843146da1f.png" style="width: 855px; height: 161px;" title="jOcWfuiwJU0V1HBSz9.png" width="855"/></p><p><br/></p><p>这个是我们的封面。</p><p><br/></p><p>第一个电影</p><p><br/></p><p><img alt="request8.png" src="images/5f9e887446239f6e570eede335722a00.png" title="pE4rRWJOr874QBeDSK.png"/></p><p><br/></p><p>第二个电影</p><p><br/></p><p><img alt="request9.png" src="images/35032a506579f3664d29fd71dbb1d04d.png" title="HlhCxAs9aA1pNoLN3E.png"/></p><p><br/></p><p>我们现在的爬虫只是获取到这个url，那接下来的任务，我们需要把这个图片给它下载下来，这个是时候，我们已经获取打了这个url，获取数据就比较简单了。</p><p><br/></p><p>代码如下：</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class MovieParser(HTMLParser):</p><p>    def __init__(self):</p><p>        HTMLParser.__init__(self)</p><p>        self.movies = []</p><p>        self.in_movies = False</p><p><br/></p><p>    def handle_starttag(self, tag, attrs):</p><p>        def _attr(attrlist, attrname):</p><p>            for attr in attrlist:</p><p>                if attr[0] == attrname:</p><p>                    return attr[1]</p><p>            return None</p><p><br/></p><p>        if tag == 'li' and _attr(attrs, 'data-title') and _attr(attrs, 'data-category') == 'nowplaying':</p><p>            movie = {}</p><p>            movie['title'] = _attr(attrs, 'data-title')</p><p>            movie['score'] = _attr(attrs, 'data-score')</p><p>            movie['director'] = _attr(attrs, 'data-director')</p><p>            movie['actors'] = _attr(attrs, 'data-actors')</p><p>            self.movies.append(movie)</p><p>            print('%(title)s|%(score)s|%(director)s|%(actors)s' % movie)</p><p>            self.in_movies = True</p><p><br/></p><p>        if tag == 'img' and self.in_movies:</p><p>            self.in_movies = False</p><p>            movie = self.movies[len(self.movies) - 1]</p><p>            movie['cover-url'] = _attr(attrs, 'src')</p><p>            _download_poster_cover(movie)   //下载电影的封面，把这个电影给它传进来</p><p><br/></p><p>def _download_poster_image(movie):   //定义一个下载电影封面的函数</p><p>    src = movie[‘poster-url’]   //取出它的url</p><p>    r = requests.get(src)   //去获取这个url</p><p>    fname = url.split('/')[-1]   //从url里面获取这个文件名</p><p>    with open(fname, 'wb') as f:  //应答的内容写进去并且使用二进制</p><p>        f.write(s.content)</p><p>    movie['poster-path'] = fname</p><p><br/></p><p>def nowplaying_movies(url):   </p><p>    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36'}</p><p>    s = requests.get(url, headers=headers)</p><p>    parser = MovieParser()</p><p>    parser.feed(s.content)</p><p>    return parser.movies</p><p><br/></p><p>if __name__ == '__main__':</p><p>    url = 'http://movie.douban.com/nowplaying/xiamen/'</p><p>    movies = nowplaying_movies(url)</p><p><br/></p><p>    import json</p><p>    print('%s' % json.dumps(movies, sort_keys=True, indent=4, separators=(',', ': ')))</p><p><br/></p><p>运行结果，可以看到poster-path，而且文件是直接保存在当前目录下。</p><p><br/></p><p><img alt="request10.png" height="203" src="images/4811c91e6bcbb13f5a99e230d0af6809.png" style="width: 869px; height: 203px;" title="t3yvrOOTarzggkdOvn.png" width="869"/></p><p><br/></p><p>可以看到这里多了很多图片，这样我们就实现了在下载热播电影的同时又把这个电影的封面图片下载下来的一个简单的爬虫。</p><p><br/></p><p><img alt="request11.png" height="259" src="images/9543621067a339b287ae0bdc574166b2.png" style="width: 875px; height: 259px;" title="i8T8v022cFd92F5sLo.png" width="875"/></p><p><br/></p><hr/><h3><span style="color: rgb(94, 207, 186);">作业</span></h3><p><br/></p><p>豆瓣音乐</p><p><br/></p><p>实现一个爬虫，获取新碟榜单曲</p><p><br/></p><p><strong>要求：</strong></p><p><strong><br/></strong></p><p>歌曲名称</p><p><br/></p><p>歌手名字</p><p><br/></p><p>豆瓣评分</p><p><br/></p><p>解析单曲封面图片url并把图片下载下来</p><p><br/></p><p>如下：这是一个豆瓣的音乐，这是个新碟榜，我希望去获取这个单曲，需要把这个音乐的名称，还有歌手的名称，豆瓣评分，以及封面图片都给它下载下来。</p><p><br/></p><p><img alt="request12.png" height="445" src="images/1230c100def8a1890b9c758b567be339.png" style="width: 849px; height: 445px;" title="5KDpoaPjCw8E0WB5DB.png" width="849"/></p><p><br/></p><p><br/></p><p><span style="color: rgb(192, 0, 0);">【本文由麦子学院独家原创，转载请注明出处并保留原文链接】</span></p><p><br/></p><p>
</p></p></div>
        </body></html>