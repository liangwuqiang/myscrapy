<!DOCTYPE html>
        <html><head><meta charset="UTF-8">
        </head><body>
        <p><center><h1>python爬虫之百度壁纸</h1></center></p>
            <div class="cont">
<h1>python爬虫之百度壁纸</h1>
<p><p><br/></p><hr/><h3><span style="color: rgb(94, 207, 186);">一个生产者，一个消费者情况下的线程</span></h3><p><br/></p><p><strong>数据分析：</strong></p><p><br/></p><p><img alt="download1.png" src="images/34afeeae5afed222274ea0d6967b1c68.png" title="wt3h83jCD5UyHnMERD.png"/></p><p><br/></p><p><strong>爬虫实现：</strong></p><p><br/></p><p>是从百度的图片网站上去下载这些壁纸下来</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>import urllib</p><p>import os</p><p><br/></p><p>def _download_image(url, folder=’image’):</p><p>    if not os.path.isdir(folder):</p><p>        os.mkdir(folder)</p><p>print('downloading %s' % url)</p><p><br/></p><p>def_(fname)s:</p><p>return os.path.join(folder,os.path.split(url) [1])</p><p>    urllib.urlretrieve(url, _filename(url))</p><p><br/></p><p>def download_wallpaper():</p><p>    # 数据分析</p><p>    # http://image.baidu.com/channel/wallpaper#%E7%83%AD%E9%97%A8%E6%8E%A8%E8%8D%90&amp;%E5%85%A8%E9%83%A8&amp;6&amp;0</p><p>    url = 'http://image.baidu.com/data/imgs'</p><p>    params = {</p><p>        'pn': 41,</p><p>        'rn': 100,</p><p>        'col': '壁纸',</p><p>        'tag': '国家地理',</p><p>        'tag3': '',</p><p>        'width': 1600,</p><p>        'height': 900,</p><p>        'ic': 0,</p><p>        'ie': 'utf8',</p><p>        'oe': 'utf-8',</p><p>        'image_id': '',</p><p>        'fr': 'channel',</p><p>        'p': 'channel',</p><p>        'from': 1,</p><p>        'app': 'img.browse.channel.wallpaper',</p><p>        't': '0.016929891658946872'</p><p>    }</p><p>    s = requests.get(url, params=params)</p><p>    imgs = s.json()['imgs']</p><p>    print('totally %d images to download' % len(imgs))</p><p>    for i in imgs:</p><p>        if 'downloadUrl' in i:</p><p>            _download_image(i['downloadUrl'], 'wallpaper')</p><p><br/></p><p>if __name__ == '__main__':</p><p>    download_wallpaper()</p><p><br/></p><p><strong>多线程爬虫：</strong></p><p><strong><br/></strong></p><p>提高它的效率，我们还是会使用生产者和消费者这种模型去实现这个多线程。</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>import urllib</p><p>import os</p><p>import threading</p><p><br/></p><p>gImageList = []   //待下载的图片的url</p><p>gCondition = threading.Condition()   //线程间同步的地址</p><p><br/></p><p>class Producer(threading.Thread):   //定义一个生产者</p><p>def run(self):   //重载run函数</p><p>        global gImageList</p><p>        global gCondition</p><p><br/></p><p>        print('%s started' % threading.current_thread())   //获取尽量多的url，去把它放到列表里面</p><p>        imgs = download_wallpaper_list()   //获取图片的列表</p><p> </p><p>        gCondition.acquire()   //获取锁</p><p>        for img in imgs:</p><p>            if 'downloadUrl' in img:</p><p>                gImageList.append(img['downloadUrl'])   //把url放到列表里面去</p><p>        print('%s: produced %d urls. Left %d urls.' % (threading.current_thread(), len(gImageList)))   //打印出剩下多少图片</p><p>        gCondition.notify_all()   //通知消费者</p><p>        gCondition.release()  //释放锁</p><p><br/></p><p><br/></p><p>class Consumer(threading.Thread):   //定义一个消费者</p><p><br/></p><p>    def __init__(self, folder='wallpaper', group=None, target=None, name=None, args=(), kwargs=None, verbose=None):</p><p>        super(Consumer, self).__init__(group, target, name, args, kwargs, verbose)</p><p>        self.folder = folder</p><p><br/></p><p>    def run(self):   //重载run函数</p><p>        print('%s started' % threading.current_thread())</p><p>        while True:   //循环获取</p><p>            global gImageList</p><p>            global gCondition</p><p><br/></p><p>            gCondition.acquire()   //获取锁</p><p>            print('%s: trying to download image. Queue length is %d' % (threading.current_thread(), len(gImageList)))   //打印出当前线程名称和图片列表</p><p>            while len(gImageList) == 0:   //是否还有图片可下载</p><p>                gCondition.wait()   //没有就需要等待</p><p>                print('%s: waken up. Queue length is %d' % (threading.current_thread(), len(gImageList)))</p><p>            url = gImageList.pop()   //取出图片的url</p><p>            gCondition.release()  //释放锁，要在下载之前，因为我们用锁保护的这段代码里面应该尽量越少越好，才能更好的提高它的并发性</p><p><br/></p><p>            _download_image(url)   //下载图片</p><p><br/></p><p>def _download_image(url, folder=’image’):</p><p>    if not os.path.isdir(folder):</p><p>        os.mkdir(folder)</p><p>print('downloading %s' % url)</p><p><br/></p><p>def_(fname)s:</p><p>return os.path.join(folder,os.path.split(url) [1])</p><p>    urllib.urlretrieve(url, _filename(url))</p><p><br/></p><p>def download_wallpaper():</p><p>    # 数据分析</p><p>    # http://image.baidu.com/channel/wallpaper#%E7%83%AD%E9%97%A8%E6%8E%A8%E8%8D%90&amp;%E5%85%A8%E9%83%A8&amp;6&amp;0</p><p>    url = 'http://image.baidu.com/data/imgs'</p><p>    params = {</p><p>        'pn': 41,</p><p>        'rn': 100,</p><p>        'col': '壁纸',</p><p>        'tag': '国家地理',</p><p>        'tag3': '',</p><p>        'width': 1600,</p><p>        'height': 900,</p><p>        'ic': 0,</p><p>        'ie': 'utf8',</p><p>        'oe': 'utf-8',</p><p>        'image_id': '',</p><p>        'fr': 'channel',</p><p>        'p': 'channel',</p><p>        'from': 1,</p><p>        'app': 'img.browse.channel.wallpaper',</p><p>        't': '0.016929891658946872'</p><p>    }</p><p>    r = requests.get(url, params=params)</p><p>    imgs = r.json()['imgs']</p><p>print('%s:totally %d images' %(threading.current_thread(),len(imgs))  //打印出线程的名字</p><p>return imgs</p><p><br/></p><p>if __name__ == '__main__':</p><p>    Producer().start()   //创建一个生产者，让它启动</p><p><br/></p><p>    for i in range(1):</p><p>        Consumer().start()  //创建一个消费者</p><p><br/></p><p>运行结果，我们可以看到，消费者已经把生产者生产出来的全部url都下载完了，因为最后它要下载的时候，发现这个池里面为空。</p><p><br/></p><p><img alt="download2.png" src="images/35621b940f300038f00cf73adc461d77.png" title="0LQ7EjNI705i1sqXxU.png"/></p><p><br/></p><p>前面2条表示，我们的生产者和消费者的线程都已经全部启动了，然后消费者准备去下载图片的时候，发现这个这个池子里面没有图片可供下载，所以它就会进入等待这个状态，那这个时候，生产者已经完成了生产，它总共获取了21个图片出来，然后它就通知消费者说已经有图片可以下载了，这个时候，我们的消费者就被唤醒，它就会去下载这个图片，接下来就可以看到，消费者这个线程就一直在下载图片。</p><p><br/></p><p><img alt="download3.png" src="images/e990538d6a27ccfac0fa02a80754da92.png" title="GlJ8WqfteHCMe5jNll.png"/></p><p><br/></p><p>我们来看一下这些下下来的图片，然后删除。</p><p><br/></p><p><img alt="download4.png" src="images/4674974bcc21fadd129787a1c69f2be0.png" title="Oe2DO565HwIP5Xeqkx.png"/></p><p><br/></p><p><br/></p><p><br/></p><p><span style="color: rgb(192, 0, 0);">【本文由麦子学院独家原创，转载请注明出处并保留原文链接】</span></p><p><br/></p><p>
</p></p></div>
        </body></html>