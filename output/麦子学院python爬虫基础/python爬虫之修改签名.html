<!DOCTYPE html>
        <html><head><meta charset="UTF-8">
        </head><body>
        <p><center><h1>python爬虫之修改签名</h1></center></p>
            <div class="cont">
<h1>python爬虫之修改签名</h1>
<p><p><br/></p><hr/><h3><span style="color: rgb(94, 207, 186);">修改签名流程分析</span></h3><p><span style="color: rgb(94, 207, 186);"><br/></span></p><p>1）向哪个url发送请求</p><p><br/></p><p>2）发送哪些数据</p><p><br/></p><p>3）有哪些特殊的头字段</p><p><br/></p><p>4）返回值长什么样</p><p><br/></p><p>5）示例：</p><p><br/></p><p>我们可以看到签名发送的url，是下面这样的url，它发送的是一个POST的数据，还有一些特殊的头字段，数据体有两个，一个是ck，一个是signature，也就是我们的签名，我们编辑的这个东西。所以，模拟这样的一个请求的关键点就是去获取这个ck，去分析这个ck到底是什么。</p><p><br/></p><p><img alt="sign1.png" src="images/984ac61b90921caf4aaf6a7c0fd76b87.png" title="0E0YYJnnXWgDsoKcSW.png"/></p><p><br/></p><p>接下来，我们来分析这个网页，看看这个ck到底是从哪儿来的。</p><p>这个就是修改签名的from</p><p><br/></p><p><img alt="sign2.png" src="images/0b78a6510c84df8344561bf220b3cd2f.png" title="GLWkGPiKAGypvieLJX.png"/></p><p><br/></p><p>这个input，它的名字是ck，它的值是xy1z，也就是说，我们要先访问这个用户的主页，然后从这个页面里面找出ck的值，把这个值作为POST这个数据的一部分，这样我们就可以模拟POST这个数据了。</p><p><br/></p><p><img alt="sign3.png" src="images/89a3c342a6aa3ad02fdcb1b98296d941.png" title="5u5jYJATGYsR8ciwDG.png"/></p><p><br/></p><p>这个是签名</p><p><br/></p><p><img alt="sign4.png" src="images/c45a50c2b55d36400bb3af13161defec.png" title="RsPTUiE8OXcD8obTpj.png"/></p><p><br/></p><p>我们从网络里面也可以看到，它实际上POST只有两个字段，我们也找到了这两个字段，ck和签名，那这样我们就变得简单，先去访问这个用户的主页，然后从这个页面去解析这个ck，然后signature就可以我们自己去设计，那这样我们就可以去修改签名了。</p><p><br/></p><p><img alt="sign5.png" src="images/d9206c7605d361e23ba2065f6563d785.png" title="fO2AdPmqJY2cf8z3OZ.png"/></p><p><br/></p><p>代码示例：</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class DoubanClient(object):</p><p>    def __init__(self):</p><p>        object.__init__(self)</p><p>        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36',</p><p>                   'origin': 'http://www.douban.com'}</p><p>        self.session = requests.session()   //创建一个session</p><p>        self.session.headers.update(headers)   //对它的头进行定制</p><p><br/></p><p><br/></p><p>    def login(self, username, password,</p><p>              source='index_nav',</p><p>              redir='http://www.douban.com/',</p><p>              login='登录'):</p><p><br/></p><p>        url = 'https://www.douban.com/accounts/login'  //访问登录的主页面，目的是为了获取验证码的id和验证码的图片</p><p>r = self.session.get(url)</p><p>            (captcha_id, captcha_url) = _get_captcha(r.content)   //从这个函数里面去获取这个验证码，去解析这个网页的内容，然后去返回这个网页里面的captcha_id,和captcha_url</p><p>        if captcha_id:</p><p>               captcha_solution = raw_input('please input solution for captcha [%s]:' %     captcha_url)   //用户输入这个 captcha_solution</p><p>        url = 'https://www.douban.com/accounts/login'</p><p>#post login request  //构建了一个post请求发送给服务器</p><p>        data = {'form_email': username,   //用户名</p><p>                'form_password': password,//密码</p><p>                'source': source,   //source</p><p>                'redir': redir,  //跳转地址</p><p>                'login': login}</p><p>        headers = {'referer': 'http://www.douban.com/accounts/login?source=main',</p><p>                   'host': 'accounts.douban.com'}  //定制的头，因为我们要完完全全去模仿http的行为</p><p>        if captcha_id:</p><p>            data['captcha-id'] = captcha_id</p><p>            data['captcha-solution'] = captcha_solution</p><p>        self.session.post(url, data=data, headers=headers)</p><p>        print(self.session.cookies.items())</p><p><br/></p><p>    def edit_signature(self, username, signature):   //用户名，签名</p><p>        url = 'https://www.douban.com/people/%s/' % username   //用户的主页</p><p>        r = self.session.get(url)  //需要去访问的用户的主页</p><p>ck = _get_ck(r.content)</p><p>        data = {'ck': _get_ck(r.content), 'signature': signature}  //从用户主页去获取ck</p><p>        url = 'https://www.douban.com/j/people/%s/edit_signature' % username   //修改签名的时候向服务器POST的url</p><p>        headers = {'referer': url,   //根据抓的包里面去定制的头</p><p>                   'host': 'www.douban.com',</p><p>                   'x-requested-with': 'XMLHttpRequest'}</p><p>        r = self.session.post(url, data=data, headers=headers)   //向这个url POST数据</p><p>        print(r.content)</p><p><br/></p><p>def _attr(attrs, attrname):</p><p>    for attr in attrs:</p><p>        if attr[0] == attrname:</p><p>            return attr[1]</p><p>    return None</p><p><br/></p><p>def _get_captcha(content):</p><p>    class CaptchaParser(HTMLParser):  //解析这个HTML，还是用的是HTMLParser</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.captcha_id = None</p><p>            self.captcha_url = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):   //去解析这个tag的头</p><p>            if tag == 'img' and _attr(attrs, 'id') == 'captcha_image' and _attr(attrs, 'class') == 'captcha_image':</p><p>                self.captcha_url = _attr(attrs, 'src')  //如果是url=src</p><p><br/></p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'captcha-id':</p><p>                self.captcha_id = _attr(attrs, 'value')    //如果是value=captcha_id</p><p><br/></p><p>    p = CaptchaParser()</p><p>    p.feed(content)</p><p>    return p.captcha_id, p.captcha_url   //返回给调用者</p><p><br/></p><p>def _get_ck(content):  //解析ck的字段</p><p><br/></p><p>    class CKParser(HTMLParser):</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.ck = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):</p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'ck':</p><p>                self.ck = _attr(attrs, 'value')</p><p><br/></p><p>    p = CKParser()</p><p>    p.feed(content)</p><p>    return p.ck</p><p><br/></p><p>if __name__ == '__main__':</p><p>    c = DoubanClient()</p><p>    c.login('username@douban.com', 'password@douban.com')   //登录时的用户名和密码</p><p>c.edit_signature('username', 'python 爬虫基础')</p><p><br/></p><p>运行结果，需要输入验证码。</p><p><br/></p><p><img alt="sign6.png" height="52" src="images/bca9cca182540e548cb94b6cd4f9bfa8.png" style="width: 1054px; height: 52px;" title="rMTFKUSqvI0CO18sXc.png" width="1054"/></p><p><br/></p><p>验证码图片</p><p><br/></p><p><img alt="sign7.png" src="images/8f455cfd22b41969cc10ac990f11bc76.png" title="34kOysA1r2aQQ3kd23.png"/></p><p><br/></p><p>输入验证码之后，成功</p><p><br/></p><p><img alt="sign8.png" height="116" src="images/ebbe6c4998f01048a4e7dc97e5e9adbc.png" style="width: 996px; height: 116px;" title="qVDeWhRcieOPlmXAqC.png" width="996"/></p><p><br/></p><p>刷新一下网页，我们发现签名改变了</p><p><br/></p><p><img alt="sign9.png" src="images/5454fc2ce34fe527b8c040702b4c5745.png" title="qoiVlLwwfI4kt0Ha7x.png"/></p><p><br/></p><p>再换一个签名，代码如下：</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class DoubanClient(object):</p><p>    def __init__(self):</p><p>        object.__init__(self)</p><p>        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36',</p><p>                   'origin': 'http://www.douban.com'}</p><p>        self.session = requests.session()   //创建一个session</p><p>        self.session.headers.update(headers)   //对它的头进行定制</p><p><br/></p><p><br/></p><p>    def login(self, username, password,</p><p>              source='index_nav',</p><p>              redir='http://www.douban.com/',</p><p>              login='登录'):</p><p><br/></p><p>        url = 'https://www.douban.com/accounts/login'  //访问登录的主页面，目的是为了获取验证码的id和验证码的图片</p><p>r = self.session.get(url)</p><p>            (captcha_id, captcha_url) = _get_captcha(r.content)   //从这个函数里面去获取这个验证码，去解析这个网页的内容，然后去返回这个网页里面的captcha_id,和captcha_url</p><p>        if captcha_id:</p><p>               captcha_solution = raw_input('please input solution for captcha [%s]:' %     captcha_url)   //用户输入这个 captcha_solution</p><p>        url = 'https://www.douban.com/accounts/login'</p><p>#post login request  //构建了一个post请求发送给服务器</p><p>        data = {'form_email': username,   //用户名</p><p>                'form_password': password,//密码</p><p>                'source': source,   //source</p><p>                'redir': redir,  //跳转地址</p><p>                'login': login}</p><p>        headers = {'referer': 'http://www.douban.com/accounts/login?source=main',</p><p>                   'host': 'accounts.douban.com'}  //定制的头，因为我们要完完全全去模仿http的行为</p><p>        if captcha_id:</p><p>            data['captcha-id'] = captcha_id</p><p>            data['captcha-solution'] = captcha_solution</p><p>        self.session.post(url, data=data, headers=headers)</p><p>        print(self.session.cookies.items())</p><p><br/></p><p>    def edit_signature(self, username, signature):   //用户名，签名</p><p>        url = 'https://www.douban.com/people/%s/' % username   //用户的主页</p><p>        r = self.session.get(url)  //需要去访问的用户的主页</p><p>ck = _get_ck(r.content)</p><p>        data = {'ck': _get_ck(r.content), 'signature': signature}  //从用户主页去获取ck</p><p>        url = 'https://www.douban.com/j/people/%s/edit_signature' % username   //修改签名的时候向服务器POST的url</p><p>        headers = {'referer': url,   //根据抓的包里面去定制的头</p><p>                   'host': 'www.douban.com',</p><p>                   'x-requested-with': 'XMLHttpRequest'}</p><p>        r = self.session.post(url, data=data, headers=headers)   //向这个url POST数据</p><p>        print(r.content)</p><p><br/></p><p>def _attr(attrs, attrname):</p><p>    for attr in attrs:</p><p>        if attr[0] == attrname:</p><p>            return attr[1]</p><p>    return None</p><p><br/></p><p>def _get_captcha(content):</p><p>    class CaptchaParser(HTMLParser):  //解析这个HTML，还是用的是HTMLParser</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.captcha_id = None</p><p>            self.captcha_url = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):   //去解析这个tag的头</p><p>            if tag == 'img' and _attr(attrs, 'id') == 'captcha_image' and _attr(attrs, 'class') == 'captcha_image':</p><p>                self.captcha_url = _attr(attrs, 'src')  //如果是url=src</p><p><br/></p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'captcha-id':</p><p>                self.captcha_id = _attr(attrs, 'value')    //如果是value=captcha_id</p><p><br/></p><p>    p = CaptchaParser()</p><p>    p.feed(content)</p><p>    return p.captcha_id, p.captcha_url   //返回给调用者</p><p><br/></p><p>def _get_ck(content):  //解析ck的字段</p><p><br/></p><p>    class CKParser(HTMLParser):</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.ck = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):</p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'ck':</p><p>                self.ck = _attr(attrs, 'value')</p><p><br/></p><p>    p = CKParser()</p><p>    p.feed(content)</p><p>    return p.ck</p><p><br/></p><p>if __name__ == '__main__':</p><p>    c = DoubanClient()</p><p>    c.login('username@douban.com', 'password@douban.com')   //登录时的用户名和密码</p><p>c.edit_signature('username', 'python Spider Basic')</p><p><br/></p><p>运行结果，请输入验证码</p><p><br/></p><p><img alt="sign10.png" height="50" src="images/a4da5f2b00ee07fd85cca1e6dda362df.png" style="width: 1030px; height: 50px;" title="ZASfl2TA3KpkurBgSa.png" width="1030"/></p><p><br/></p><p>验证码图片</p><p><br/></p><p><img alt="sign11.png" src="images/2da0ac5a50e3771e50e13f52d84bc1e1.png" title="spS4ZyvcOx6kfJNtCu.png"/></p><p><br/></p><p>输入验证码，成功</p><p><br/></p><p><img alt="sign12.png" height="112" src="images/ba1f102caf935a91b2e92092f16b5c1d.png" style="width: 1031px; height: 112px;" title="a0uve70c3KzFS7W2kG.png" width="1031"/></p><p><br/></p><p>验证一下，刷新一下网页</p><p><br/></p><p><img alt="sign13.png" src="images/f4fe7ed84b990d81b8c7a5c04c70fb28.png" title="Ns5QYPHWehABiUcHvG.png"/></p><p><br/></p><p>那我们如果不登录修改签名会怎样呢？</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class DoubanClient(object):</p><p>    def __init__(self):</p><p>        object.__init__(self)</p><p>        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36',</p><p>                   'origin': 'http://www.douban.com'}</p><p>        self.session = requests.session()   //创建一个session</p><p>        self.session.headers.update(headers)   //对它的头进行定制</p><p><br/></p><p><br/></p><p>    def login(self, username, password,</p><p>              source='index_nav',</p><p>              redir='http://www.douban.com/',</p><p>              login='登录'):</p><p><br/></p><p>        url = 'https://www.douban.com/accounts/login'  //访问登录的主页面，目的是为了获取验证码的id和验证码的图片</p><p>r = self.session.get(url)</p><p>            (captcha_id, captcha_url) = _get_captcha(r.content)   //从这个函数里面去获取这个验证码，去解析这个网页的内容，然后去返回这个网页里面的captcha_id,和captcha_url</p><p>        if captcha_id:</p><p>               captcha_solution = raw_input('please input solution for captcha [%s]:' %     captcha_url)   //用户输入这个 captcha_solution</p><p>        url = 'https://www.douban.com/accounts/login'</p><p>#post login request  //构建了一个post请求发送给服务器</p><p>        data = {'form_email': username,   //用户名</p><p>                'form_password': password,//密码</p><p>                'source': source,   //source</p><p>                'redir': redir,  //跳转地址</p><p>                'login': login}</p><p>        headers = {'referer': 'http://www.douban.com/accounts/login?source=main',</p><p>                   'host': 'accounts.douban.com'}  //定制的头，因为我们要完完全全去模仿http的行为</p><p>        if captcha_id:</p><p>            data['captcha-id'] = captcha_id</p><p>            data['captcha-solution'] = captcha_solution</p><p>        self.session.post(url, data=data, headers=headers)</p><p>        print(self.session.cookies.items())</p><p><br/></p><p>    def edit_signature(self, username, signature):   //用户名，签名</p><p>        url = 'https://www.douban.com/people/%s/' % username   //用户的主页</p><p>        r = self.session.get(url)  //需要去访问的用户的主页</p><p>ck = _get_ck(r.content)</p><p>        data = {'ck': _get_ck(r.content), 'signature': signature}  //从用户主页去获取ck</p><p>        url = 'https://www.douban.com/j/people/%s/edit_signature' % username   //修改签名的时候向服务器POST的url</p><p>        headers = {'referer': url,   //根据抓的包里面去定制的头</p><p>                   'host': 'www.douban.com',</p><p>                   'x-requested-with': 'XMLHttpRequest'}</p><p>        r = self.session.post(url, data=data, headers=headers)   //向这个url POST数据</p><p>        print(r.content)</p><p><br/></p><p>def _attr(attrs, attrname):</p><p>    for attr in attrs:</p><p>        if attr[0] == attrname:</p><p>            return attr[1]</p><p>    return None</p><p><br/></p><p>def _get_captcha(content):</p><p>    class CaptchaParser(HTMLParser):  //解析这个HTML，还是用的是HTMLParser</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.captcha_id = None</p><p>            self.captcha_url = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):   //去解析这个tag的头</p><p>            if tag == 'img' and _attr(attrs, 'id') == 'captcha_image' and _attr(attrs, 'class') == 'captcha_image':</p><p>                self.captcha_url = _attr(attrs, 'src')  //如果是url=src</p><p><br/></p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'captcha-id':</p><p>                self.captcha_id = _attr(attrs, 'value')    //如果是value=captcha_id</p><p><br/></p><p>    p = CaptchaParser()</p><p>    p.feed(content)</p><p>    return p.captcha_id, p.captcha_url   //返回给调用者</p><p><br/></p><p>def _get_ck(content):  //解析ck的字段</p><p><br/></p><p>    class CKParser(HTMLParser):</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.ck = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):</p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'ck':</p><p>                self.ck = _attr(attrs, 'value')</p><p><br/></p><p>    p = CKParser()</p><p>    p.feed(content)</p><p>    return p.ck</p><p><br/></p><p>if __name__ == '__main__':</p><p>    c = DoubanClient()</p><p>c.edit_signature('username', '1111')</p><p><br/></p><p>运行结果，提示错误，要求登录后修改</p><p><br/></p><p><img alt="sign14.png" height="77" src="images/9674ce886f300a25934ad7ec6b2aa4c4.png" style="width: 1015px; height: 77px;" title="3EauNZumdwz5k5EeDk.png" width="1015"/></p><p><br/></p><p>我们刷新一下，发现签名没有变</p><p><br/></p><p><img alt="sign15.png" src="images/ddde63f22e20c69fd5f4c619700ae988.png" title="bJPqw8tN3x3M4GsBRC.png"/></p><p><br/></p><p><br/></p><p><br/></p><p><strong><span style="color: rgb(192, 0, 0);">【本文由麦子学院独家原创，转载请注明出处并保留原文链接】</span></strong></p><p><br/></p><p>
</p></p></div>
        </body></html>