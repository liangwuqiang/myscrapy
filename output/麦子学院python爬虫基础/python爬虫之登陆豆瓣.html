<!DOCTYPE html>
        <html><head><meta charset="UTF-8">
        </head><body>
        <p><center><h1>python爬虫之登陆豆瓣</h1></center></p>
            <div class="cont">
<h1>python爬虫之登陆豆瓣</h1>
<p><p></p><hr/><h3><span style="color: rgb(94, 207, 186);">爬虫实例：登录豆瓣</span></h3><p><br/></p><p><strong>功能</strong></p><p><br/></p><p>1）登录豆瓣</p><p><br/></p><p>2）修改签名</p><p><br/></p><p><strong>登录流程分析</strong></p><p><br/></p><p>1）向哪个url发送请求？</p><p><br/></p><p>2）发送哪些数据？</p><p><br/></p><p>3）有哪些特殊的头字段？</p><p><br/></p><p>4）验证码问题如何解决？</p><p><br/></p><p><strong>登录使用的技术</strong></p><p><br/></p><p>1）使用requests.Session来处理cookies</p><p><br/></p><p>2）模拟浏览器的登录行为</p><p><br/></p><p><strong>示例：</strong></p><p><br/></p><p>在这里面我们需要去观察这个数据到底交互是什么样子，我们这里使用Chrome的开发者工具来抓一个网络数据包去分析豆瓣的网站在登录的过程中到底交互了什么数据。</p><p><br/></p><p>我们来看一下登录请求中的Form Data就是我们登录的时候发送给服务器的数据，也就是说，如果我们在代码里面，构建一个http请求，然后把所有这些数据用http POST的方法，向url去POST这样一个请求，那么我们就可以去模拟一个登录的过程，这里面需要注意的一点就是，除了我们的Form Data，还有一些http头也尽量去模拟，这样就避免在开发的过程中去调试，因为各个服务器在实现的时候，它有它自己的判断，所以最好的方法就是Form Data要完全模拟，然后发送请求的headers也要去模拟，那这样我们就可以把http请求发送到POST里面去。</p><p><br/></p><p><img alt="land1.png" src="images/2f4cea6a9dcaba082f9b8c6265614d6c.png" title="68YzQEXDmDgYADv9pR.png"/></p><p><br/></p><p><img alt="land2.png" src="images/cc7ec8f2d42120540dc423d7526db85a.png" title="QmtUarmXo9L3aqMChH.png"/></p><p><br/></p><p>我们设置一下登录的应答，这里有3条cookies，登录完成以后，只要这3条cookies再发送给服务器，我们就作为一个合法的登录用户去操作只有登录用户才能操作的事情，比如，修改签名。</p><p><br/></p><p><img alt="land3.png" src="images/cb38d6070ec811fa76f153e85e85dd88.png" title="kuOWiztQvJCpIOGeHf.png"/></p><p><br/></p><p>我们回到登录的请求来Form Data，这6个Data到底是哪里来的，里面有email，password还有验证码是我们自己输入的，还有一个cpatcha-id到底是哪儿来的？为了了解cpatcha-id到底是哪儿来的，我们需要去了解一下登录页面，因为我们相信这个一定是从登录页面来发过来的，我们来分析一下登录页面，我们看一下这个登录页面的form。我们可以看到这个source是隐藏的登录框，它的值是main，redirect它的意思是说登录完后要跳转到这个网址上去，所以这个也不会影响我们登录的成功与失败。</p><p><br/></p><p><img alt="land4.png" src="images/695c648be13b80a9d9085ee44390d125.png" title="F1GYfhrtUJsIWb4T6n.png"/></p><p><br/></p><p>我们接下来看email，这个是登录用户名，这个是用户输入的。</p><p><br/></p><p><img alt="land5.png" src="images/0781e7deae38bac9c104b74808c39b67.png" title="8fM3eULBvSYvwBxhjc.png"/></p><p><br/></p><p>密码</p><p><br/></p><p><img alt="land6.png" src="images/1079e32ac10445cebc225297d402294e.png" title="PryyaOaDfPNEhqrG4R.png"/></p><p><br/></p><p>验证码，这个img就是验证码的图片，这个text就是这个用户根据这个图片来输入的验证码，这就防止我们的用户使用代码去登录，这个captcha-id就是后面的一串数字。</p><p><br/></p><p><img alt="land7.png" src="images/d52e6e268c8f5ff63f811f7616641425.png" title="vnIAKWeUSpD0q2E0N0.png"/></p><p><br/></p><p>所以我们这样登录流程就有了，我们使用request去访问这个页面，然后从得到的html去解析这个captcha-id，去解析这个图片，然后我们就可以构造这个完整的请求POST给这个login。</p><p><br/></p><p>最后我们再来讲一下这个验证码怎么做，这个验证码就是为了防止这个程序去自动登录，也就是说程序没有进行验证码，针对我们的用户进行密码的暴力破解，那这个网站的安全性是比较低的，那加了这个验证码之后，就可以防止这个程序去自动登录，那针对这个问题，那我们的程序怎么去解决呢？</p><p><br/></p><p>那我们的解决方案是这样的，我们把这个图片的url给爬下来，然后我们用人眼去看这个图片，然后输入图片上的单词，所以我们的登录还是半自动的，所以我们要实现一个全自动的话，我们要涉及到一个继续学习的内容，那一个思路就是尽量去下载多的这个验证码图片，就是豆瓣网上的这个验证码图片，然后我们训练一个机器学习的算法，采用这个图像识别的方法，去把这个字母都把它识别出来，然后再把它转换成一个单词，自动的填进来，这个就是我们用机器学习的算法去破解这个思路，当然啦，这个豆瓣的验证码实际上是比较简单，因为它永远都是一个单词，如果看过12306购票的验证码的话，那个就比较复杂了，它用了很复杂的组合的验证码，那个要破解起来难度就比较大，不过，豆瓣这个其实相对起来是比较简单的，那我们今天的示例不会讲破解验证码的内容，因为破解验证码的内容是继续学习的内容，超出了我们这节课的内容范围。</p><p><br/></p><p><img alt="land8.png" src="images/dd8b66e864c678ef35b5cd7108f5a751.png" title="fewhceHgEwoiDOVKvV.png"/></p><p><br/></p><p>我们现在来看一下代码怎么写，怎么来模拟这个登录的过程。</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p>class DoubanClient(object):</p><p>    def __init__(self):</p><p>        object.__init__(self)</p><p>        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36',</p><p>                   'origin': 'http://www.douban.com'}</p><p>        self.session = requests.session()   //创建一个session</p><p>        self.session.headers.update(headers)   //对它的头进行定制</p><p><br/></p><p><br/></p><p>    def login(self, username, password,</p><p>              source='index_nav',</p><p>              redir='http://www.douban.com/',</p><p>              login='登录'):</p><p><br/></p><p>        url = 'https://www.douban.com/accounts/login'  //访问登录的主页面，目的是为了获取验证码的id和验证码的图片</p><p>r = self.session.get(url)</p><p>            (captcha_id, captcha_url) = _get_captcha(r.content)   //从这个函数里面去获取这个验证码，去解析这个网页的内容，然后去返回这个网页里面的captcha_id,和captcha_url</p><p>        if captcha_id:</p><p>               captcha_solution = raw_input('please input solution for captcha [%s]:' %     captcha_url)   //用户输入这个 captcha_solution</p><p>        url = 'https://www.douban.com/accounts/login'</p><p>#post login request  //构建了一个post请求发送给服务器</p><p>        data = {'form_email': username,   //用户名</p><p>                'form_password': password,//密码</p><p>                'source': source,   //source</p><p>                'redir': redir,  //跳转地址</p><p>                'login': login}</p><p>        headers = {'referer': 'http://www.douban.com/accounts/login?source=main',</p><p>                   'host': 'accounts.douban.com'}  //定制的头，因为我们要完完全全去模仿http的行为</p><p>        if captcha_id:</p><p>            data['captcha-id'] = captcha_id</p><p>            data['captcha-solution'] = captcha_solution</p><p>        self.session.post(url, data=data, headers=headers)</p><p>        print(self.session.cookies.items())</p><p><br/></p><p>def _attr(attrs, attrname):</p><p>    for attr in attrs:</p><p>        if attr[0] == attrname:</p><p>            return attr[1]</p><p>    return None</p><p><br/></p><p>def _get_captcha(content):</p><p>    class CaptchaParser(HTMLParser):  //解析这个HTML，还是用的是HTMLParser</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.captcha_id = None</p><p>            self.captcha_url = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):   //去解析这个tag的头</p><p>            if tag == 'img' and _attr(attrs, 'id') == 'captcha_image' and _attr(attrs, 'class') == 'captcha_image':</p><p>                self.captcha_url = _attr(attrs, 'src')  //如果是url=src</p><p><br/></p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'captcha-id':</p><p>                self.captcha_id = _attr(attrs, 'value')    //如果是value=captcha_id</p><p><br/></p><p>    p = CaptchaParser()</p><p>    p.feed(content)</p><p>    return p.captcha_id, p.captcha_url   //返回给调用者</p><p><br/></p><p>def _get_ck(content):</p><p><br/></p><p>    class CKParser(HTMLParser):</p><p>        def __init__(self):</p><p>            HTMLParser.__init__(self)</p><p>            self.ck = None</p><p><br/></p><p>        def handle_starttag(self, tag, attrs):</p><p>            if tag == 'input' and _attr(attrs, 'type') == 'hidden' and _attr(attrs, 'name') == 'ck':</p><p>                self.ck = _attr(attrs, 'value')</p><p><br/></p><p>    p = CKParser()</p><p>    p.feed(content)</p><p>    return p.ck</p><p><br/></p><p>if __name__ == '__main__':</p><p>    c = DoubanClient()</p><p>    c.login('username@douban.com', 'password@douban.com')   //登录时的用户名和密码</p><p>  </p><p>运行结果，这个时候提醒我们输入验证码</p><p><br/></p><p><img alt="land9.png" height="35" src="images/c7ded2b2eafc27a0902204dd57347957.png" style="width: 1015px; height: 35px;" title="l4a0AmxMMyeVhWZSK6.png" width="1015"/></p><p><br/></p><p>我们把这个验证码打开</p><p><br/></p><p><img alt="land10.png" src="images/691df377154866f7d262930ba9c22878.png" title="WFJrJnJjjimxthYPM9.png"/></p><p><br/></p><p>输入验证码。</p><p><br/></p><p><img alt="land11.png" height="84" src="images/cecde652885232359e8d63372f9b2cae.png" style="width: 1021px; height: 84px;" title="5HMmUdaHYAdAgl93pc.png" width="1021"/></p><p><br/></p><p><br/></p><p>这节课的内容就到这个地方，下节课我们会修改这个签名，然后用这个登录网站的用户去修改签名，也顺便验证一下，这个登录是否成功。</p><p><br/></p><p><br/></p><p><strong><span style="color: rgb(192, 0, 0);">【本文由麦子学院独家原创，转载请注明出处并保留原文链接】</span></strong></p><p><br/></p><p>
</p></p></div>
        </body></html>