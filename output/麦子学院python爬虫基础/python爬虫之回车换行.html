<!DOCTYPE html>
        <html><head><meta charset="UTF-8">
        </head><body>
        <p><center><h1>python爬虫之回车换行</h1></center></p>
            <div class="cont">
<h1>python爬虫之回车换行</h1>
<p><p><br/></p><hr/><h3><span style="color: rgb(94, 207, 186);">回车换行</span></h3><p><br/></p><p><img alt="grab12.png" src="images/d913e5a6a112d03e6dbd4a31fcc3f750.png" title="12aV2Nfh3B0QxxvFE2.png"/></p><p><br/></p><p>还有诗词数据无法解析出来，我们查看一下，这个诗里面没有内容。</p><p><br/></p><p><img alt="grab13.png" src="images/e6377c6ef943712f93438c3c5a442ddf.png" title="Z8S4BU4yohzc2RyZQV.png"/></p><p><br/></p><p>我们打开这个诗词，查看这里面为什么没有内容，这个时候，这个p标签没有align=”center”这样的一个标签。</p><p><br/></p><p><img alt="grab14.png" src="images/a613e265e015ac8fa5ea36a4651bb0ec.png" title="CPnKdthDtjtCZ4XkWH.png"/></p><p><br/></p><p>还有一个是文字被图片替换掉了，那这个时候怎么处理呢？这个数据的处理是，使用正则表达式把整个a这个标签的一整段都给它替换成alt这个属性，那这样我们才算真正完成了这个爬虫。</p><p><br/></p><p><img alt="grab15.png" src="images/07c2eedc9adb09c47dbc57e8f722c23f.png" title="qWxveOBaj3aNS4Zfzv.png"/></p><p><br/></p><p>我们重点关注正则表达式，我们回到代码这边，看看我们怎么处理这个回车换行的。</p><p><br/></p><p># -*- coding: utf-8 -*-</p><p>import requests</p><p>import re</p><p>from HTMLParser import HTMLParser</p><p><br/></p><p># ugly code to fix UnicodeDecodeError</p><p>import sys</p><p>reload(sys)</p><p>sys.setdefaultencoding('utf8')</p><p><br/></p><p><br/></p><p>def _attr(attrs, attrname):</p><p>    for attr in attrs:</p><p>        if attr[0] == attrname:</p><p>            return attr[1]</p><p>    return None</p><p><br/></p><p><br/></p><p>class PoemParser(HTMLParser):</p><p>    def __init__(self):</p><p>        HTMLParser.__init__(self)</p><p>        self.in_div = False</p><p>        self.in_a = False</p><p>        self.pattern = re.compile(r'(.*)\((.*)\)')</p><p>        self.tangshi_list = []</p><p>        self.current_poem = {}</p><p><br/></p><p>    def handle_starttag(self, tag, attrs):</p><p>        if tag == 'div' and _attr(attrs, 'class') == 'guwencont2':</p><p>            self.in_div = True</p><p><br/></p><p>        if tag == 'a' and self.in_div:</p><p>            self.in_a = True</p><p>            self.current_poem['url'] = _attr(attrs, 'href')</p><p><br/></p><p>    def handle_endtag(self, tag):</p><p>        if tag == 'div':</p><p>            self.in_div = False</p><p><br/></p><p>        if tag == 'a':</p><p>            self.in_a = False</p><p><br/></p><p>    def handle_data(self, data):</p><p>        if self.in_a:</p><p>            m = self.pattern.match(data)</p><p>            if m:</p><p>                self.current_poem['title'] = m.group(1)</p><p>                self.current_poem['author'] = m.group(2)</p><p>                self.tangshi_list.append(self.current_poem)</p><p>                self.current_poem = {}</p><p><br/></p><p>class PoemContentParser(HTMLParser):</p><p>    def __init__(self):</p><p>        HTMLParser.__init__(self)</p><p>        self.content = []   //把它变成一个列表</p><p>        self.in_p = False   //定义一个标志位</p><p><br/></p><p>    def handle_starttag(self, tag, attrs): </p><p>        if tag == 'p' and _attr(attrs, 'align') == 'center':   //标签等于p，而且align的属性等于center</p><p>            self.in_p = True   //这样的标签我们认为是一个合法的标签</p><p><br/></p><p>    def handle_endtag(self, tag):   //退出了p这个字段以后，我们就认为不再这个数据范围里面</p><p>        if tag == 'p':   //标志位</p><p>            self.in_p = False</p><p><br/></p><p>    def handle_data(self, data):   //处理数据</p><p>        if self.in_p:   //只要在我们的合法标签内，我们就认为是我们想要的数据</p><p>             self.content.append(data)</p><p><br/></p><p>def retrive_tangshi_300():</p><p>    url = 'http://www.gushiwen.org/gushi/tangshi.aspx'</p><p>    r = requests.get(url)</p><p>    parser = PoemParser()</p><p>    parser.feed(r.content)</p><p>    return parser.tangshi_list</p><p><br/></p><p>def download_poem(poem):</p><p>    r = requests.get('http://www.gushiwen.org' + poem['url'])</p><p>    parser = PoemContentParser()</p><p>    parser.feed(r.content)</p><p>poem['content'] = '\n'.join(parser.content)   //把这个值放在字典里面</p><p><br/></p><p>def trim_ws(s):   //把所有的回车换行符都给它删掉</p><p>    s = re.sub(r'\s+', '', s)  //空白符都给它删掉</p><p><br/></p><p>def trim_href(s):</p><p>    return trim_ws(s)</p><p><br/></p><p><br/></p><p>def trim_test():</p><p>    s = """月落乌啼霜满天，江枫渔火对愁眠。</p><p>           姑苏城外</p><p>           寒山</p><p>           寺，夜半钟声到客船。"""</p><p>    print(trim_ws(s))</p><p><br/></p><p>    s = """</p><p>        凉风起天末，君子意如何。&lt;br&gt;</p><p>        鸿雁几时到，江湖秋水多。&lt;br&gt;</p><p>        文章憎命达，魑魅喜人过。&lt;br&gt;</p><p>        应共冤魂语，投&lt;a href="http://www.gushiwen.org/GuShiWen_148389ab4e.aspx"&gt;&lt;img style="vertical-align:middle;" src="http://www.gushiwen.org/favicon.ico" alt="诗" title="诗" width="14" height="14"&gt;&lt;/a&gt;</p><p>        赠汨罗。"""</p><p>    print(trim_href(s))</p><p><br/></p><p><br/></p><p>if __name__ == '__main__':</p><p>trim_test()</p><p><br/></p><p>运行结果，我们可以看到，之前异常的回车换行符已经被处理掉，现在比较干净了。</p><p><br/></p><p><img alt="grab16.png" src="images/dd23da63d53a5d697998713284b52390.png" title="GDQ17ydtJ7EpH6SE5F.png"/></p><p><br/></p><p><br/></p><p><br/></p><p><span style="color: rgb(192, 0, 0);">【本文由麦子学院独家原创，转载请注明出处并保留原文链接】</span></p><p><br/></p><p>
</p></p></div>
        </body></html>